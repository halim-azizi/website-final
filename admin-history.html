<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sales History - Mulliri Antik Admin</title>
    <meta name="robots" content="noindex, nofollow" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="./styles.css" />
    <style>
        .admin-section {
            background: #0c0c0e;
            color: #fff;
            min-height: 100vh;
            padding: 60px 0;
        }

        .admin-topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .admin-topbar .welcome-msg {
            font-size: 13px;
            color: var(--muted);
        }

        .logout-btn {
            background: rgba(255, 85, 85, 0.1);
            border: 1px solid rgba(255, 85, 85, 0.3);
            color: #ff5555;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.04em;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 85, 85, 0.2);
        }

        .admin-card {
            background: #131316;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 30px;
            margin-top: 30px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1a1e;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 20px;
        }

        .stat-card .stat-label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .stat-card .stat-value {
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
        }

        .stat-card .stat-value.white {
            color: #fff;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .history-table th {
            text-align: left;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--gold);
            font-weight: 800;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .history-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
            font-size: 14px;
            vertical-align: middle;
        }

        .status-pill {
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-completed {
            background: rgba(57, 181, 74, 0.12);
            color: #39b54a;
        }

        .filters {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .filter-group input {
            background: #1a1a1e;
            border: 1px solid rgba(255, 255, 255, 0.12);
            color: #fff;
            padding: 10px 14px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .total-badge {
            font-weight: 900;
            color: var(--gold);
            font-size: 15px;
        }

        .item-list {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
        }

        .order-id {
            font-family: monospace;
            font-weight: 700;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .loading-state {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: var(--muted);
        }

        .empty-state .empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
        }

        .section-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .section-divider h2 {
            font-size: 16px;
            font-weight: 800;
            color: #fff;
            white-space: nowrap;
        }

        .section-divider hr {
            flex: 1;
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }
    </style>
</head>

<body>

    <header class="header">
        <div class="container header__inner">
            <nav class="nav nav--left">
                <a href="index.html">STORE</a>
                <a href="products.html">PRODUCTS</a>
            </nav>
            <a class="logo" href="index.html">
                <img style="width:70px;" src="assets/mulliri-png.png" />
            </a>
            <div class="header__right">
                <span style="font-size: 10px; font-weight: 800; color: var(--gold);" class="desktop-only-text">ADMIN
                    PANEL</span>
                <a href="cart.html" class="iconbtn cart-btn">
                    <span class="ico ico-bag"></span>
                    <span class="badge" id="cartCount">0</span>
                </a>
            </div>
            <!-- MOBILE BURGER -->
            <button class="mnav__burger" id="menuToggle" aria-label="Open Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <!-- MOBILE DROPDOWN -->
        <div class="mnav" id="mobileNav">
            <div class="container mnav__inner">
                <a href="index.html">HOME</a>
                <a href="products.html">STORE</a>
                <a href="admin-history.html">SALES HISTORY</a>
            </div>
        </div>
    </header>

    <main class="admin-section">
        <div class="container">
            <div class="admin-topbar">
                <div>
                    <h1 class="sectionTitle white" style="margin-bottom: 4px;">Sales History</h1>
                    <p class="welcome-msg">Welcome back, <strong id="adminEmail" style="color:#fff;"></strong></p>
                </div>
                <button class="logout-btn" id="logoutBtn">‚éã SIGN OUT</button>
            </div>

            <!-- Stats Row -->
            <div class="stats-row" id="statsRow">
                <div class="stat-card">
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value white" id="statOrders">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value" id="statRevenue">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Order Value</div>
                    <div class="stat-value" id="statAvg">‚Äî</div>
                </div>
            </div>

            <div class="admin-card">
                <div class="section-divider">
                    <h2>Transaction Records</h2>
                    <hr>
                    <button class="btn btn--gold" onclick="loadTransactions()"
                        style="padding: 8px 18px; font-size: 13px; white-space: nowrap;">‚Ü∫ Refresh</button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Filter by Date</label>
                        <input type="date" id="dateFilter" onchange="renderHistory()">
                    </div>
                    <div class="filter-group">
                        <label>Search Order ID</label>
                        <input type="text" id="searchFilter" placeholder="ORD-..." oninput="renderHistory()">
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>Order ID</th>
                                <th>Products</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="5">
                                    <div class="loading-state">
                                        <div class="spinner"></div>
                                        <p>Loading transactions...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script src="cart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script>
        let allTransactions = [];

        // Auth check + init
        async function init() {
            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'admin-login.html';
                return;
            }

            // Show admin email
            const emailEl = document.getElementById('adminEmail');
            if (emailEl) emailEl.textContent = session.user.email;

            // Mobile menu
            const toggleBtn = document.getElementById("menuToggle");
            const mobileNav = document.getElementById("mobileNav");
            if (toggleBtn && mobileNav) {
                toggleBtn.addEventListener("click", () => mobileNav.classList.toggle("open"));
            }

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                await window.supabaseClient.auth.signOut();
                window.location.href = 'admin-login.html';
            });

            await loadTransactions();
        }

        async function loadTransactions() {
            document.getElementById('historyBody').innerHTML = `
                <tr><td colspan="5">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading transactions...</p>
                    </div>
                </td></tr>`;

            try {
                const { data, error } = await window.supabaseClient
                    .from('transactions')
                    .select('*')
                    .order('date', { ascending: false });

                if (error) throw error;

                allTransactions = data || [];
                updateStats(allTransactions);
                renderHistory();
            } catch (err) {
                console.error('Failed to load transactions:', err);

                // Fallback: try localStorage
                allTransactions = JSON.parse(localStorage.getItem('mulliri_transactions') || '[]')
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                if (allTransactions.length > 0) {
                    updateStats(allTransactions);
                    renderHistory();
                } else {
                    document.getElementById('historyBody').innerHTML = `
                        <tr><td colspan="5">
                            <div class="empty-state">
                                <div class="empty-icon">‚ö†Ô∏è</div>
                                <p>Could not load data. Check your Supabase credentials.</p>
                                <p style="font-size:12px; margin-top:4px;">${err.message}</p>
                            </div>
                        </td></tr>`;
                }
            }
        }

        function updateStats(transactions) {
            const count = transactions.length;
            const revenue = transactions.reduce((sum, t) => sum + (parseFloat(t.total) || 0), 0);
            const avg = count > 0 ? revenue / count : 0;

            document.getElementById('statOrders').textContent = count;
            document.getElementById('statRevenue').textContent = revenue.toFixed(2) + '‚Ç¨';
            document.getElementById('statAvg').textContent = avg.toFixed(2) + '‚Ç¨';
        }

        function renderHistory() {
            const body = document.getElementById('historyBody');
            const dateVal = document.getElementById('dateFilter').value;
            const searchVal = document.getElementById('searchFilter').value.toUpperCase().trim();

            let filtered = allTransactions.filter(t => {
                const dateMatch = !dateVal || (t.date || '').startsWith(dateVal);
                const searchMatch = !searchVal || (t.id || '').toUpperCase().includes(searchVal);
                return dateMatch && searchMatch;
            });

            if (filtered.length === 0) {
                body.innerHTML = `
                    <tr><td colspan="5">
                        <div class="empty-state">
                            <div class="empty-icon">üì≠</div>
                            <p>No transactions found.</p>
                        </div>
                    </td></tr>`;
                return;
            }

            body.innerHTML = filtered.map(t => {
                const dateObj = new Date(t.date || t.created_at);
                const dateStr = dateObj.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })
                    + ' ¬∑ ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const items = Array.isArray(t.items) ? t.items : [];
                const itemsStr = items.map(i => `${i.quantity}√ó ${i.name}`).join('<br>') || '‚Äî';

                return `
                <tr>
                    <td style="white-space:nowrap; color: var(--muted); font-size:13px;">${dateStr}</td>
                    <td class="order-id">${t.id}</td>
                    <td class="item-list">${itemsStr}</td>
                    <td class="total-badge">${parseFloat(t.total || 0).toFixed(2)}‚Ç¨</td>
                    <td><span class="status-pill status-completed">${t.status || 'Completed'}</span></td>
                </tr>`;
            }).join('');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>